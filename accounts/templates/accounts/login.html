{% extends 'base.html' %}

{% block content %}
  <h2>Login</h2>
  <form id="login-form">
    {% csrf_token %}
    <p>
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>
    </p>
    <p>
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" required>
    </p>
    <button type="submit">Login with Email</button>
  </form>
  <button id="google-login-btn">Login with Google</button>
  <p id="error-message" style="color: red;"></p>
  <p>Don't have an account? <a href="{% url 'signup' %}">Sign Up here</a>.</p>

  <script type="module">
    import { signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const auth = window.firebaseAuth;
    const loginForm = document.getElementById('login-form');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const errorMessage = document.getElementById('error-message');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginForm.email.value;
      const password = loginForm.password.value;

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const idToken = await userCredential.user.getIdToken();
        await sendTokenToDjango(idToken);
      } catch (error) {
        errorMessage.textContent = error.message;
      }
    });

    googleLoginBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        const userCredential = await signInWithPopup(auth, provider);
        const idToken = await userCredential.user.getIdToken();
        await sendTokenToDjango(idToken);
      } catch (error) {
        errorMessage.textContent = error.message;
      }
    });

    async function sendTokenToDjango(idToken) {
      const response = await fetch('{% url "firebase_login" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ idToken: idToken })
      });

      if (response.ok) {
        window.location.href = '{% url "generate" %}'; // Redirect to generate page on success
      } else {
        const errorData = await response.json();
        errorMessage.textContent = errorData.error || 'Django login failed';
      }
    }
  </script>
{% endblock %}